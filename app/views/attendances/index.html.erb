<div class="container mt-5 mb-5">
  <% # ヘッダー部分：ボタンとタイトルにゆとりを持たせる %>
  <div class="d-flex justify-content-between align-items-end mb-4 border-bottom pb-3">
    <div>
      <h2 class="fw-bold mb-1">勤怠履歴一覧</h2>
      <p class="text-muted small mb-0">これまでの勤務記録を確認・出力できます</p>
    </div>
    
    <%= link_to attendances_path(format: :csv), class: "btn btn-primary btn-lg shadow-sm" do %>
      <i class="bi bi-download me-2"></i>CSVダウンロード
    <% end %>
  </div>

<% @grouped_attendances.each do |user, attendances| %>
  <div class="card shadow-sm mb-5 border-0">
    <div class="card-header bg-primary text-white py-3 d-flex justify-content-between align-items-center">
      <h5 class="mb-0 fw-bold"><i class="bi bi-person-circle me-2"></i><%= user.name %> さんの勤務記録</h5>
      <span class="badge bg-white text-primary">合計 <%= attendances.count %> 件</span>
    </div>
    
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr class="small text-secondary">
            <th class="ps-4">勤務日</th>
            <th>出勤</th>
            <th>退勤</th>
            <th>実労働時間</th>
            <th class="text-end pe-4">交通費</th>
          </tr>
        </thead>
        <tbody>
          <% user_total_seconds = 0 %>
          <% user_total_cost = 0 %>

          <% attendances.each do |attendance| %>
            <% # 祝日情報の取得（APIから取得した @holidays を使用） %>
            <% holiday_name = @holidays[attendance.work_date.to_s] %>
            
            <tr class="<%= 'table-danger table-opacity-10' if holiday_name %>">
              <td class="ps-4">
                <%= attendance.work_date.strftime("%Y/%m/%d") %>
                <% if holiday_name %>
                  <span class="badge bg-danger ms-1" style="font-size: 0.7rem;"><%= holiday_name %></span>
                <% else %>
                  <small class="text-muted">(<%= %w(日 月 火 水 木 金 土)[attendance.work_date.wday] %>)</small>
                <% end %>
              </td>
              <td class="text-muted"><%= attendance.start_time&.strftime("%H:%M") %></td>
              <td class="text-muted"><%= attendance.end_time&.strftime("%H:%M") %></td>
              <td class="fw-bold text-primary"><%= attendance.working_duration %></td>
              <td class="text-end pe-4">¥<%= number_with_delimiter(attendance.extra_travel_cost || 0) %></td>
            </tr>

            <% # 合計時間の集計（秒単位） %>
            <% if attendance.start_time && attendance.end_time %>
              <% duration = attendance.end_time - attendance.start_time %>
              <% duration += 24.hours if duration < 0 %>
              <% work_seconds = duration - (attendance.break_minutes.to_i * 60) %>
              <% user_total_seconds += [work_seconds, 0].max %>
            <% end %>
            <% user_total_cost += attendance.extra_travel_cost.to_i %>
          <% end %>
        </tbody>

        <tfoot class="table-group-divider bg-light">
          <tr class="fw-bold">
            <td colspan="3" class="text-end py-3">このユーザーの合計：</td>
            <td class="py-3 text-primary">
              <i class="bi bi-clock-history me-1"></i>
              <%= "#{(user_total_seconds / 3600).to_i}時間#{(user_total_seconds % 3600 / 60).to_i}分" %>
            </td>
            <td class="text-end pe-4 py-3 text-dark">
              ¥<%= number_with_delimiter(user_total_cost) %>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
<% end %>

  <div class="mt-3 text-center">
    <%= link_to "ホームに戻る", home_path %>
  </div>
</div>